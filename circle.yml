machine:
  environment:
    GYM_CODE_SIGNING_IDENTITY: 'iPhone Distribution: Nicolas Gebauer (BJJKE72WM4)'
    ANDROID_HOME: /usr/local/opt/android-sdk
    XCODE_SCHEME: 'WifiUC'
  xcode:
    version: '8.2'

dependencies:
  pre:
    # Project
    - brew reinstall node
    - npm install
    - npm install -g react-native-cli
    - npm run generate_env $WIFIUC_USER $WIFIUC_PASS
    # Android
    - brew install android-sdk
    - echo y | android update sdk --no-ui --all --filter platform-tools
    - echo y | android update sdk --no-ui --all --filter android-24
    - echo y | android update sdk --no-ui --all --filter android-23
    - echo y | android update sdk --no-ui --all --filter build-tools-25.0.2
    - security add-generic-password -a android_keystore -l android_keystore -s android_keystore -w $WIFIUC_ANDROID_KEYSTORE
    # Fastlane
    - sudo gem update fastlane
    - brew install imagemagick
  cache_directories:
    - node_modules

test:
  pre:
    - npm run lint
  override:
    - npm run test
  post:
    # Bundle iOS
    # - react-native bundle --dev false --entry-file index.ios.js --bundle-output ios/main.jsbundle --platform ios
    # Bundle Android
    # - react-native bundle --dev false --entry-file index.android.js --bundle-output android/main.jsbundle --platform android
    # Run them both!
    - npm run android
    - npm run ios

deployment:
  development:
    branch: dev
    commands:
      # iOS
      - deploy=$(scripts/git_deploy.sh) cd ios; fastlane $deploy
      - cp ios/WifiUC.app.dSYM.zip $CIRCLE_ARTIFACTS
      - cp ios/WifiUC.ipa $CIRCLE_ARTIFACTS
      # Android
      - deploy=$(scripts/git_deploy.sh) cd android; fastlane $deploy
      - scripts/ci/deploy_android.sh
      - cp android/app/build/outputs/apk/app-release.apk $CIRCLE_ARTIFACTS

deployment:
  store:
    tag: /v[0-9]+(\.[0-9]+)*/
    owner: negebauer
    commands:
      # iOS
      - cd ios; fastlane store
      - cp ios/WifiUC.app.dSYM.zip $CIRCLE_ARTIFACTS
      - cp ios/WifiUC.ipa $CIRCLE_ARTIFACTS
      # Android
      - cd android; fastlane store
      - cp android/app/build/outputs/apk/app-release.apk $CIRCLE_ARTIFACTS

general:
  artifacts:
    - logs/
